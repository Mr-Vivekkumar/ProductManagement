<div class="container my-4">
  <h2 class="text-center mb-4">Product Management</h2>

  <!-- Add New Product -->
  <div class="card mb-4">
    <div class="card-header">Add New Product</div>
    <div class="card-body">
      <form [formGroup]="newProductForm" (ngSubmit)="createProduct()">
        <div class="row mb-3">
          <div class="col">
            <label for="name" class="form-label">Name</label>
            <input
              type="text"
              id="name"
              formControlName="name"
              class="form-control"
            />
            <div *ngIf="isInvalid('name')" class="text-danger small">
              Name is required and must be at least 3 characters.
            </div>
          </div>

          <div class="col">
            <label for="price" class="form-label">Price</label>
            <input
              type="number"
              id="price"
              formControlName="price"
              class="form-control"
            />
            <div *ngIf="isInvalid('price')" class="text-danger small">
              Price must be a positive number.
            </div>
          </div>

          <div class="col">
            <label for="category" class="form-label">Category</label>
            <select
              id="category"
              formControlName="categoryId"
              class="form-select"
            >
              <option value="">Select Category</option>
              <option *ngFor="let category of categories" [value]="category.id">
                {{ category.name }}
              </option>
            </select>
            <div *ngIf="isInvalid('categoryId')" class="text-danger small">
              Category is required.
            </div>
          </div>

          <div class="col">
            <label for="image" class="form-label">Image</label>
            <input
              type="file"
              id="image"
              (change)="onFileChange($event)"
              class="form-control"
            />
          </div>
        </div>

        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="newProductForm.invalid"
        >
          Add Product
        </button>
      </form>
    </div>
  </div>

  <!-- Product List -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>Products List</div>
      <div>
        <button
          class="btn btn-outline-secondary btn-sm"
          (click)="sortData('name')"
        >
          Sort by Name
        </button>
        <button
          class="btn btn-outline-secondary btn-sm"
          (click)="sortData('price')"
        >
          Sort by Price
        </button>
      </div>
      <div class="btn-group">
        <button
          class="btn btn-outline-success btn-sm"
          (click)="downloadReport('csv')"
        >
          Download CSV
        </button>
        <button
          class="btn btn-outline-primary btn-sm"
          (click)="downloadReport('xlsx')"
        >
          Download XLSX
        </button>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle mb-0">
        <thead class="table-dark">
          <tr>
            <th>#</th>
            <th>Image</th>
            <th>Name</th>
            <th>Price</th>
            <th>Category</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let product of products; let i = index">
            <td>{{ i + 1 }}</td>
            <td>
              <img
                [src]="env.fileServerUrl + product.image_url"
                alt="{{ product.name }}"
                class="img-thumbnail"
                style="width: 50px; height: 50px; object-fit: cover"
              />
            </td>
            <td>{{ product.name }}</td>
            <td>â‚¹{{ product.price }}</td>
            <td>{{ product.category_name }}</td>
            <td class="text-end">
              <button
                class="btn btn-sm btn btn-warning me-2"
                (click)="editProduct(product)"
              >
                Edit
              </button>
              <button
                class="btn btn-sm btn-danger"
                (click)="deleteProduct(product.id)"
              >
                Delete
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="card-footer d-flex justify-content-center">
      <nav>
        <ul class="pagination mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="navigatePage(currentPage - 1)"
              >Previous</a
            >
          </li>

          <li
            class="page-item"
            *ngFor="let page of getPageNumbers()"
            [class.active]="page === currentPage"
          >
            <a class="page-link" (click)="navigatePage(page)">{{ page }}</a>
          </li>

          <li
            class="page-item"
            [class.disabled]="currentPage === getPageNumbers().length"
          >
            <a class="page-link" (click)="navigatePage(currentPage + 1)"
              >Next</a
            >
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- Edit Product Modal -->
  <div *ngIf="editingProduct" class="edit-modal">
    <div class="edit-content">
      <h4>Edit Product</h4>
      <form [formGroup]="editingProductForm" (ngSubmit)="updateProduct()">
        <div class="mb-3">
          <label>Name</label>
          <input type="text" formControlName="name" class="form-control" />
        </div>

        <div class="mb-3">
          <label>Price</label>
          <input type="number" formControlName="price" class="form-control" />
        </div>

        <div class="mb-3">
          <label>Category</label>
          <select formControlName="categoryId" class="form-select">
            <option value="">Select Category</option>
            <option *ngFor="let category of categories" [value]="category.id">
              {{ category.name }}
            </option>
          </select>
        </div>
        <div class="form-group mb-3">
          <label>Current Image</label>

          <div>
            <img
              [src]="environment.fileServerUrl + editingProduct.image"
              alt="Current Product Image"
              class="img-thumbnail"
              style="max-width: 200px"
            />
          </div>
        </div>
        <div class="mb-3">
          <label>Change Image</label>
          <input
            type="file"
            (change)="onFileChange($event, true)"
            class="form-control"
          />
        </div>

        <div class="d-flex justify-content-end">
          <button
            type="submit"
            class="btn btn-success me-2"
            [disabled]="editingProductForm.invalid"
          >
            Update
          </button>
          <button
            type="button"
            class="btn btn-secondary"
            (click)="cancelEdit()"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
